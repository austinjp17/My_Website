---
title: "Negative Binomial Regression Notes"
name: "Austin Palmer"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\newcommand\myatop[2]{\left[{{#1}\atop#2}\right]}

We'll use September 2017 poll results to model the number of books someone has read in the past year by two predictors:

1)  Their age

2)  Their response to the question of whether they'd rather be *wise but unhappy* or *happy but unwise*

### Variable Definitions

$\hspace{5mm}Y_i$: Number of books read by person $i$

$\hspace{5mm}X_1$: Person $i$'s age

$\hspace{5mm}X_2$: 1 if answer wise but unhappy

### Data exploration

First we will load and process the `pulse_of_the_nation` dataset from the **bayesrules** package. In doing so, we'll remove outliers, focusing on those who have read fewer than 100 books.

```{r, include=FALSE}
# Load Packages
library(bayesrules)
library(rstanarm)
library(bayesplot)
library(tidyverse)
library(tidybayes)
library(broom.mixed)
```

```{r}
# Load data
data(pulse_of_the_nation)
pulse <- pulse_of_the_nation %>%
  filter(books < 100)
```

```{r}
ggplot(pulse, aes(x = books)) +
  geom_histogram(color = "white")
```

In initially examining the frequency distribution of book read irregardless of age or poll response, we can see that most people read about 11 books, but the frequency of number of books read is right skewed, bounded at 0, and seems to exponentially decrease as the number of books increase.

```{r}
ggplot(pulse, aes(y = books, x = age)) + 
  geom_point()
```

Moving in to examining the relationship between age and number of books read, we see *a lot* of variability across ages. There appears to be a very weak relationship between age and number of books.

```{r}
ggplot(pulse, aes(y = books, x = wise_unwise)) + 
  geom_boxplot()
```

Looking at the poll response to books relationships, it seems that those who prefer wisdom to happiness tend to read more books but have a higher variability among the group.

## **Poisson Model**

Given the skewed, count structure of our `books` variable $Y$, the Poisson regression tool is a reasonable *first approach*.

```{r Building Poisson Model, results=FALSE}
b0<-normal(0,2.5,autoscale=TRUE)
b1<-normal(0,2.5,autoscale = TRUE)
sigma<-exponential(1,autoscale = TRUE)

poisson_model <- stan_glm(books ~ age + wise_unwise,
                          data = pulse, family=poisson,
                          prior_intercept = b0,
                          prior = b1,
                          prior_aux = sigma,
                          chains=4, iter=5000*2, seed=84735)
```

BUT the results are not great. Examining a quick `pp_check()`:

```{r Poisson Posterior Check}
pp_check(poisson_model) +
  xlab("Books")
```

As opposed to the *observed* book readership, which is right skewed and tends to be below 11 books per year, the Poisson posterior simulations are symmetric around 11 books per year. Simply, the model is wrong. *Why?* Recall that Poisson regression preserves the Poisson property of equal mean and variance. That is, it assumes that among subjects of similar age and perspectives on wisdom versus happiness, the *typical* number of books read per year is roughly equivalent to the variability in books read. Yet the `pp_check()` highlights that we actually observe *high variability* in book readership relative to *low average* readership. We can confirm this with some numerical summaries.

```{r}
pulse %>% 
  summarize(mean = mean(books), var = var(books))
```

First the discrepancy in the mean and variance in readership is true across *all* subjects in our survey. On average people read 10.9 books per year, but the variance in book readership is a massive 198 books.

When we `cut()` the age range into three groups, we see this is also true among subjects in the same general age bracket and with the same take o wisdom versus happiness.

```{r}
pulse %>% 
  group_by(cut(age,3), wise_unwise) %>% 
  summarize(mean = mean(books), var = var(books))
```

For example, among respondents in the 45 to 72 year age bracket that prefer wisdom to happiness, the average readership was 12.5 books, a relatively small number in comparison to the variance of 270 books.

In this case, we can say that book readership $Y$ is **overdispersed**

**Overdispersion** - A random variable $Y$ is **overdispersed** if the *observed* variability in $Y$ exceeds the variability *expected* by the assumed probability model of $Y$.

Wen our count response variable $Y$ is too overdispered to squeeze into the Poisson regression assumptions, we have some options. Two common options, which produce similar results, are to:

1)  Include an overdispersion parameter in the Poisson data model

2)  Utilize a non-Poisson data model

We will take the 2nd approach and use a *Negative Binomial probability model* as a substitute for our overdispersed Poisson Model. Like the Poisson model, the Negative Binomial is suitable for count data. Unlike the Poisson, the Negative Binomial does **not** make the restrictive assumption that $E(Y) = Var(Y)$.

## **Negative Binomial Model**

### Definition

Let random variable $Y$ be some count, $Y \in \{0,1,2...\}$, that can be modeled by the Negative Binomial with **mean parameter** $\mu$ and **reciprocal dispersion parameter** $r$:

$$Y|\mu,r \sim NegBin(\mu,r)$$

Then $Y$ has conditional probability mass function (pmf):

$$f(y|\mu,r) = \left[{{y+r-1}\atop r}\right](\frac{r}{u+r})^r(\frac{\mu}{u+r})^y \text{ for } y \in \{0,1,2,...\}$$

with **unequal** mean and variance:

$$E(Y|\mu,r) = \mu \hspace{5mm}\text{and}\hspace{5mm} Var(Y|\mu,r) = \mu + \frac{\mu^2}{r}$$

**Comparisons to the Poisson Model**

For *large* reciprocal dispersion parameters $r$, $Var(Y) \approx E(Y)$ and $Y$ behaves much like a Poisson count variable. For *small* $r$, $Var(Y) > E(Y)$ and $Y$ is **overdispersed** in comparison to a Poisson count variable with the same mean. This is illustrated by a few examples below:

**Pois(5)**

```{r}
nums = seq(0,25,1)
ggplot(data.frame(x=nums), aes(x)) +
  geom_point(aes(y=dpois(x, 5)), colour="red")
```

**NegBin(5, 10,000)**

```{r}
ggplot(data.frame(x=nums), aes(x)) +
  geom_point(aes(y=dnbinom(x, mu=5, size=10000)), colour="red")
```

**NegBin(5,2)**

```{r}
ggplot(data.frame(x=nums), aes(x)) +
  geom_point(aes(y=dnbinom(x, mu=5, size=2)), colour="red")
```

To make the switch, we pick up the extra reciprocal dispersion parameter, r \> 0, for which the Exponential provides a reasonable prior structure.

### NegBin Model

```{r Build Negative Binomial Model, results=FALSE}
b0<-normal(0,2.5,autoscale=TRUE)
b1<-normal(0,2.5,autoscale=TRUE)
sigma<-exponential(1,autoscale=TRUE)
negbin_model <- stan_glm(books ~ age + wise_unwise,
                         data = pulse, family = neg_binomial_2,
                         prior_intercept = b0,
                         prior = b1,
                         prior_aux = sigma,
                         chains = 4, iter = 5000*2, seed=84735)
```

```{r}
prior_summary(negbin_model)
```

From the autofitted weakly informative priors, we get:

$\hspace{10mm}\text{data:}\hspace{10mm} \\ Y_i|\beta_0,\beta_1,\beta_2 \sim NegBin(\mu_i,r) \hspace{3mm}\text{st}\hspace{3mm} log(\mu_i) = \beta_0 + \beta_1X_{i1} + \beta_2X_{i2}$

$\hspace{10mm}\text{priors:}\hspace{10mm} \\ \beta_{0c} \sim N(0, 2.5^2) \\ \beta_1 \sim N(0, 0.15^2) \\ r \sim Exp(1)$

### Posterior Predictive Check

```{r Negative Binomial Posterior Check, warning=FALSE}
pp_check(negbin_model) +
  xlim(0, 75) + 
  xlab("books")
```

The results are fantastic. By incorporating more flexible assumptions about the variability in book readership, the posterior simulation of very closely matches the observed behavior in our survey data. That is, the Negative Binomial is at least much less wrong than the Poisson model.

### Analysis

With this peace of mind, we can continue just as we would with a Poisson analysis. Mainly, since it utilizes a log transform, the interpretation of the Negative Binomial regression coefficients follows the same framework as in the Poisson setting.

```{r}
tidy(negbin_model, conf.int = TRUE, conf.level = 0.80)
```

-   When controlling for a person's prioritization of wisdom versus happiness, there's no significant association between age and book readership - 0 is squarely in the 80% posterior credible interval for `age` coefficient $\beta_1$

-   When controlling for a persons age, people that prefer wisdom over happiness tend to read more than those that prefer the opposite - the 80% posterior credible interval for $\beta_2$ is comfortably above 0. Assuming they're the same age, we'd expect a person who prefers wisdom to happiness to read 1.3 times as many, or 30% more, books as someone who prefers happiness (\$e\^0.266 = 1.3).
